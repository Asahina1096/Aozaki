---
// 纯静态 Astro 组件，无 React 依赖
// 使用 SVG 图标代替 lucide-react，减少 JS 包体积
---

<header
  class="sticky top-0 z-50 w-full border-b border-border/20 bg-background/95 backdrop-blur-md supports-backdrop-filter:bg-background/60 transition-all duration-200"
>
  <div class="container flex h-16 items-center justify-between">
    <div class="flex items-center gap-3">
      <h1
        class="text-2xl font-bold bg-gradient-to-r from-primary via-primary/70 to-primary/30 bg-clip-text text-transparent"
      >
        Aozaki
      </h1>
    </div>

    <div class="flex items-center gap-2">
      <button
        id="theme-toggle"
        class="inline-flex h-10 w-10 items-center justify-center rounded-md text-muted-foreground transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background hover:text-foreground"
        aria-label="切换主题"
        data-current-mode="system"
      >
        <span class="sr-only">切换主题</span>
        <span data-theme-icon="light" class="theme-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2"></path>
            <path d="M12 20v2"></path>
            <path d="m4.93 4.93 1.41 1.41"></path>
            <path d="m17.66 17.66 1.41 1.41"></path>
            <path d="M2 12h2"></path>
            <path d="M20 12h2"></path>
            <path d="m6.34 17.66-1.41 1.41"></path>
            <path d="m19.07 4.93-1.41 1.41"></path>
          </svg>
        </span>
        <span data-theme-icon="system" class="theme-icon hidden">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 2v2" />
            <path
              d="M14.837 16.385a6 6 0 1 1-7.223-7.222c.624-.147.97.66.715 1.248a4 4 0 0 0 5.26 5.259c.589-.255 1.396.09 1.248.715"
            />
            <path d="M16 12a4 4 0 0 0-4-4" />
            <path d="m19 5-1.256 1.256" />
            <path d="M20 12h2" />
          </svg>
        </span>
        <span data-theme-icon="dark" class="theme-icon hidden">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
          </svg>
        </span>
      </button>
    </div>
  </div>
</header>

<script>
  // 类型定义
  type ThemeMode = "light" | "system" | "dark";

  interface AppearanceAPI {
    get: () => ThemeMode;
    set: (mode: ThemeMode) => void;
  }

  interface ThemeChangeEvent extends Event {
    detail?: { mode: ThemeMode };
  }

  declare global {
    interface Window {
      __aozakiAppearance?: AppearanceAPI;
      __aozakiThemeChangeHandler?: (event: Event) => void;
    }
  }

  // 主题切换逻辑
  function initThemeToggle() {
    const toggle = document.getElementById("theme-toggle");
    if (!toggle || toggle.dataset.bound === "true") return;

    const api = window.__aozakiAppearance;
    if (!api) return;

    const MODE_SEQUENCE: ThemeMode[] = ["light", "system", "dark"];
    const MODE_LABELS: Record<ThemeMode, string> = {
      light: "浅色模式",
      system: "跟随系统",
      dark: "深色模式",
    };

    const iconMap = {
      light: toggle.querySelector('[data-theme-icon="light"]'),
      system: toggle.querySelector('[data-theme-icon="system"]'),
      dark: toggle.querySelector('[data-theme-icon="dark"]'),
    };

    function updateButton(mode: ThemeMode) {
      if (!toggle) return;
      toggle.dataset.currentMode = mode;
      toggle.setAttribute("aria-label", `主题：${MODE_LABELS[mode]}`);
      Object.entries(iconMap).forEach(([key, element]) => {
        if (!element) return;
        element.classList.toggle("hidden", key !== mode);
      });
    }

    function getNextMode(current: ThemeMode): ThemeMode {
      const index = MODE_SEQUENCE.indexOf(current);
      if (index === -1) return MODE_SEQUENCE[0];
      return MODE_SEQUENCE[(index + 1) % MODE_SEQUENCE.length];
    }

    function handleClick() {
      if (!api) return;
      const current = api.get();
      const next = getNextMode(current);
      api.set(next);
    }

    function handleThemeChange(event: Event) {
      if (!api) return;
      const themeEvent = event as ThemeChangeEvent;
      const mode =
        (themeEvent?.detail && themeEvent.detail.mode) || api.get();
      updateButton(mode);
    }

    toggle.addEventListener("click", handleClick);
    if (window.__aozakiThemeChangeHandler) {
      window.removeEventListener(
        "aozaki-theme-change",
        window.__aozakiThemeChangeHandler
      );
    }
    window.__aozakiThemeChangeHandler = handleThemeChange;
    window.addEventListener("aozaki-theme-change", handleThemeChange);
    toggle.dataset.bound = "true";

    updateButton(api.get());
  }

  initThemeToggle();

  // 支持 Astro View Transitions
  document.addEventListener("astro:page-load", initThemeToggle);
</script>
