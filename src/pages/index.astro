---
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import { ServerList } from "@/components/ServerList";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getAPIClient } from "@/lib/api";
import type { ServerStats } from "@/lib/types/serverstatus";
import { css } from "../../styled-system/css";

// 在服务器端获取初始数据
let initialServers: ServerStats[] = [];
let initialError: string | null = null;

try {
  const client = getAPIClient();
  const data = await client.getStats();
  initialServers = data.servers;
} catch (err) {
  initialError = err instanceof Error ? err.message : "获取数据失败";
  console.error("Failed to fetch initial server data:", err);
}
---

<BaseLayout>
  <div class={css({ display: "flex", minH: "screen", flexDirection: "column" })}>
    <!-- Header 改为静态 Astro 组件，主题切换使用原生 JS -->
    <Header />

    <main class={css({ flex: "1" })}>
      <div class={css({ maxW: "1400px", mx: "auto", px: "8", py: "8" })}>
        <div class={css({ mb: "8", display: "flex", alignItems: "center" })}>
          <h2 class={css({ fontSize: "2xl", md: { fontSize: "3xl" }, fontWeight: "bold", color: "primary" })}>节点状态</h2>
        </div>

        <!-- ServerList 接收 SSR 初始数据，客户端负责定时刷新 -->
        <ServerList
          client:load
          initialServers={initialServers}
          initialError={initialError}
          refreshInterval={2000}
        />
      </div>
    </main>

    <!-- Footer 改为静态 Astro 组件 -->
    <Footer />
  </div>
</BaseLayout>
