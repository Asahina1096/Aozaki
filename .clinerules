# .clinerules
# =========================================================
# Komari Aozaki å¼€å‘è§„èŒƒï¼ˆCline MCP + Context7 é›†æˆï¼‰
# =========================================================
# æŠ€æœ¯æ ˆ: Astro 4.x + React 18 + TypeScript 5.x + TailwindCSS 4.x + shadcn/ui + Recharts 3.x
# åŒ…ç®¡ç†å™¨: Bun 1.3.x
# =========================================================

version: 1

mcp:
  servers:
    # -----------------------------------------------------
    # Context7 MCP Server â€” æä¾›è¯­ä¹‰ä¸Šä¸‹æ–‡ä¸è§„åˆ™è§£é‡Š
    # -----------------------------------------------------
    - id: context7
      type: context
      provider: Context7
      config:
        load: true
        strict: true
        autoExplainRules: true
        summary:
          include:
            - "src/components/**/*"
            - "src/hooks/**/*"
            - "src/lib/**/*"
          exclude:
            - "dist"
            - "node_modules"
        behavior:
          onViolation: "warn"      # è¿è§„æ—¶å‘å‡ºè­¦å‘Šä½†ä¸ä¸­æ–­
          onCritical: "error"      # ä¸¥é‡è¿è§„ä¸­æ–­æ„å»º
          autoFormat: true         # è‡ªåŠ¨ä¿®æ­£éƒ¨åˆ†æ ¼å¼åŒ–é—®é¢˜

    # -----------------------------------------------------
    # Filesystem MCP Server â€” æ–‡ä»¶ç³»ç»Ÿçº§åˆ«è§„åˆ™éªŒè¯
    # -----------------------------------------------------
    - id: filesystem
      type: filesystem
      provider: Filesystem
      config:
        root: .
        include:
          - "src/**/*.{ts,tsx,astro}"
          - "scripts/**/*.ts"
        exclude:
          - "node_modules"
          - "dist"
        watch: true
        behavior:
          onCreate: "validate"
          onUpdate: "validate"
          onDelete: "ignore"

# =========================================================
# é¡¹ç›®å¼€å‘è§„åˆ™
# =========================================================
rules:
  # -----------------------------------------------------
  # ğŸ“¦ åŸºç¡€è§„èŒƒ
  # -----------------------------------------------------
  - id: tech-stack
    description: å¿…é¡»ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„æŠ€æœ¯æ ˆ
    assert:
      astro: "4.x"
      react: "18.x"
      typescript: "5.x"
      tailwindcss: "4.x"
      recharts: "3.x"

  - id: package-manager
    description: å¿…é¡»ä½¿ç”¨ Bun ä½œä¸ºåŒ…ç®¡ç†å™¨
    require:
      - "bun.lockb"
    forbid:
      - "yarn.lock"
      - "package-lock.json"
      - "pnpm-lock.yaml"

  - id: bun-scripts
    description: æ‰€æœ‰è¿è¡Œè„šæœ¬éœ€ä½¿ç”¨ Bun
    check: |
      æ‰€æœ‰å‘½ä»¤å¿…é¡»ä»¥ `bun run` å½¢å¼æ‰§è¡Œï¼š
        bun install
        bun run dev
        bun run check:all

  # -----------------------------------------------------
  # ğŸ§© å‘½åä¸å¯¼å…¥è§„åˆ™
  # -----------------------------------------------------
  - id: naming
    description: å‘½åè§„èŒƒ
    match:
      - "*.ts"
      - "*.tsx"
    patterns:
      component: "PascalCase"
      variable: "camelCase"
      constant: "UPPER_SNAKE_CASE"
      hook: "^use[A-Z]"

  - id: import-order
    description: å¯¼å…¥é¡ºåº
    order:
      - react
      - third-party
      - internal
      - types

  # -----------------------------------------------------
  # âš›ï¸ ç»„ä»¶å¼€å‘è§„åˆ™
  # -----------------------------------------------------
  - id: component-rules
    description: React ç»„ä»¶å¼€å‘å¼ºåˆ¶è¦æ±‚
    enforce:
      - must_use_typescript: true
      - prefer_shadcn_ui: true
      - chart_disable_animation: true
      - useMemo_for_data: true
      - responsive_design: "mobile-first"

  # -----------------------------------------------------
  # ğŸ“Š å›¾è¡¨ç»„ä»¶è§„èŒƒ
  # -----------------------------------------------------
  - id: chart-structure
    description: æ‰€æœ‰å›¾è¡¨ç»„ä»¶å¿…é¡»é€šè¿‡ BaseChart å®ç°
    require:
      - "BaseChart"
    enforce:
      - use_transformData_and_renderChart: true
      - lowercase_config_keys: true
      - import_recharts_components: true
      - reuse_shared_config: "CHART_CONFIG"
      - reuse_gradients: true
    forbid:
      - define_chart_config_locally
      - uppercase_config_keys
      - direct_use_of_ResponsiveContainer

  - id: chart-example
    description: å›¾è¡¨ç¤ºä¾‹å¯¹ç…§
    examples:
      good: |
        renderChart={(chartData, { xAxis, yAxis, cartesianGrid, tooltip }) => (
          <LineChart data={chartData}>
            <CartesianGrid {...cartesianGrid} />
            <XAxis {...xAxis} />
          </LineChart>
        )}
      bad: |
        renderChart={(chartData, { XAxis, YAxis }) => (
          <LineChart>
            <CartesianGrid {...XAxis} />  # âŒ é”™è¯¯ï¼šé…ç½®åå†²çª
          </LineChart>
        )}

  # -----------------------------------------------------
  # âš™ï¸ æ€§èƒ½ä¼˜åŒ–
  # -----------------------------------------------------
  - id: performance
    description: æ€§èƒ½ä¼˜åŒ–çº¦æŸ
    enforce:
      - memoize_chart_data: true
      - no_inline_objects: true
      - reuse_chart_configs: true
      - use_skeleton_loading: true

  # -----------------------------------------------------
  # ğŸ§  æ•°æ®ç®¡ç†
  # -----------------------------------------------------
  - id: data-management
    description: æ•°æ®ç®¡ç†è§„èŒƒ
    enforce:
      - global_singleton: "NodeStore"
      - dev_polling: true
      - prod_websocket: true
      - history_http_rpc2: true
      - charts_hook: "useAllChartsData"

  # -----------------------------------------------------
  # ğŸ”Œ æ•°æ®è·å– Hooks
  # -----------------------------------------------------
  - id: hooks-usage
    description: Hooks ç»Ÿä¸€è°ƒç”¨è§„èŒƒ
    examples:
      useNodesData: |
        import { useNodesData } from "hooks/useNodeStore";
        const { clients, statuses, loading } = useNodesData(1000);
      useNodeData: |
        import { useNodeData } from "hooks/useNodeStore";
        const { client, status } = useNodeData(uuid, 1000);
      useAllChartsData: |
        import { useAllChartsData } from "hooks/useAllChartsData";
        const { chartsData, timeRanges, setChartTimeRange } = useAllChartsData(uuid);

  # -----------------------------------------------------
  # ğŸ§° å·¥å…·å‡½æ•°
  # -----------------------------------------------------
  - id: utils
    description: å·¥å…·å‡½æ•°å¯¼å…¥è§„åˆ™
    require:
      - "formatBytes"
      - "formatPercent"
      - "formatSpeed"
      - "formatTimestamp"
    from: "lib/utils"

  # -----------------------------------------------------
  # ğŸš¨ é”™è¯¯ä¸çŠ¶æ€å¤„ç†
  # -----------------------------------------------------
  - id: error-handling
    description: é”™è¯¯ä¸ç©ºçŠ¶æ€æ˜¾ç¤ºè§„èŒƒ
    enforce:
      - show_retry_on_network_error: true
      - show_empty_state_on_no_data: true
      - show_skeleton_on_loading: true
      - graceful_degradation: true

  # -----------------------------------------------------
  # ğŸ’¡ æ ¸å¿ƒåŸåˆ™
  # -----------------------------------------------------
  - id: philosophy
    description: ä¿æŒé«˜è´¨é‡ã€æ€§èƒ½ä¼˜åŒ–ä¸å“è¶Šç”¨æˆ·ä½“éªŒ
    enforce:
      - code_quality: "high"
      - performance: "optimized"
      - ux: "smooth"
