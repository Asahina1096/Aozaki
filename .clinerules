# .clinerules
# =========================================================
# Komari Aozaki 开发规范（精简版）
# 技术栈: Astro 5.x • React 19 • TypeScript 5 • TailwindCSS 4 • shadcn/ui • Recharts 3
# 包管理器: Bun 1.3.x
# 最后更新: 2025-10-17 (v1.5)
# =========================================================

version: 1

meta:
  tech_stack: "Astro 5.x / React 19 / TypeScript 5 / TailwindCSS 4 / shadcn/ui / Recharts 3"
  package_manager: "Bun 1.3.x (唯一包管理工具)"
  principles:
    - "类型安全 + 清晰结构"
    - "性能目标: 首屏 < 1.5s, 交互 < 100ms, TTI < 3s"
    - "体验优先: Skeleton, 错误友好, 全断点响应式"
    - "完善工具链: Lint • Format • Type Check"

mcp:
  priority: "MCP 工具优先于传统工具"
  principle: "能用 MCP 就用 MCP，避免重复造轮子"

  servers:
    - id: sequentialthinking
      summary: "复杂任务拆解与方案规划"
      priority: "CRITICAL"
      mandatory_use:
        - "任何超过 3 步的复杂任务"
        - "需要多阶段规划的架构设计"
        - "不确定最佳实现路径时"
        - "涉及多个模块/文件的重构"
      use_when:
        - "需求模糊或步骤较多"
        - "需要架构/流程推演"
      anti_pattern:
        - "直接动手不规划"
        - "边做边想没有整体方案"

    - id: context7
      summary: "文档、最佳实践、版本兼容性检索"
      priority: "CRITICAL"
      mandatory_use:
        - "使用任何不熟悉的 API/Hook/组件前"
        - "遇到版本升级/兼容性问题时"
        - "需要最佳实践参考时"
        - "实现新功能前查证官方推荐方案"
      libraries:
        astro: "/withastro/docs"
        react: "/facebook/react"
        recharts: "/recharts/recharts"
        tailwindcss: "/tailwindlabs/tailwindcss"
        typescript: "/microsoft/typescript"
      triggers:
        - "不确定 / 不知道 / 如何"
        - "API / 函数 / Hook / props"
        - "最佳实践 / 优化 / 示例"
        - "版本 / 兼容 / 升级"
      usage_flow:
        - "resolve-library-id → get-library-docs"
        - "引用官方建议再制定方案"
      anti_pattern:
        - "凭记忆写代码不查文档"
        - "使用过时/不推荐的 API"
        - "忽略版本差异导致问题"

    - id: filesystem
      summary: "以 MCP 方式读取/列出项目文件"
      priority: "HIGH"
      mandatory_use:
        - "列出目录结构时（优于 execute_command ls）"
        - "搜索代码模式时（优于 execute_command grep）"
        - "读取文件内容时（可用 MCP read_text_file）"
        - "探索项目结构时（directory_tree 一次性获取）"
      tools: ["list_directory", "directory_tree", "search_files", "read_text_file"]
      advantages:
        - "原生支持，无需命令行解析"
        - "结构化输出，易于处理"
        - "支持递归与过滤"
      anti_pattern:
        - "用 ls/find 等命令代替 MCP 工具"
        - "手动拼接路径而非用 directory_tree"

    - id: fetch-mcp
      summary: "获取网页内容并转换为多种格式"
      priority: "HIGH"
      mandatory_use:
        - "需要查看外部文档/网页时"
        - "获取 API 响应内容时"
        - "需要 HTML → Markdown 转换时"
        - "爬取公开信息时"
      use_when:
        - "需要获取网页/API 内容"
        - "需要将 HTML 转换为 Markdown 或纯文本"
        - "需要获取外部文档或数据"
      tools: ["fetch_html", "fetch_markdown", "fetch_txt", "fetch_json"]
      features:
        - "支持自定义请求头"
        - "可设置最大长度限制（默认 50000）"
        - "支持分页获取（start_index + max_length）"
      anti_pattern:
        - "用 curl/wget 然后手动解析"
        - "忽视 MCP 原生 Markdown 转换能力"

  decision_flow:
    step1: "遇到任务时，优先思考：是否有 MCP 工具能完成？"
    step2: "如果有多个工具选择，MCP 工具优先级高于传统工具"
    step3: "只有在 MCP 无法满足需求时，才使用传统工具（execute_command 等）"
    examples:
      - scenario: "需要列出项目目录"
        wrong: "execute_command: ls -la"
        right: "use_mcp_tool: filesystem/list_directory"
      - scenario: "需要搜索代码中的某个函数"
        wrong: "execute_command: grep -r 'function_name'"
        right: "use_mcp_tool: filesystem/search_files"
      - scenario: "需要查看 React 19 新 API"
        wrong: "凭记忆或搜索引擎"
        right: "use_mcp_tool: context7/resolve-library-id + get-library-docs"
      - scenario: "需要获取某个网页内容"
        wrong: "execute_command: curl | html2text"
        right: "use_mcp_tool: fetch-mcp/fetch_markdown"

workflows:
  plan_mode:
    mcp_first: true
    must:
      - "【CRITICAL】复杂任务必须先用 sequentialthinking 拆解"
      - "【CRITICAL】任何 API/库使用前必须 context7 确认"
      - "【MANDATORY】用 filesystem 工具探索目录与源码，禁用 ls/find"
      - "计划中引用真实路径、现有模式和预期输出"
    steps:
      - "任务评估 → 如果复杂度 > 3 步，启用 sequentialthinking"
      - "文档确认 → 【必须】context7: resolve-library-id + get-library-docs"
      - "结构探索 → 【必须】filesystem: list_directory / directory_tree"
      - "代码定位 → 【优先】filesystem: search_files（而非 grep）"
      - "文件阅读 → 【可选】filesystem: read_text_file 或内置 read_file"
      - "整合成分步计划，说明要改的文件与方法"
    forbidden:
      - "跳过 MCP 工具直接用传统命令"
      - "不查文档凭印象写代码"

  act_mode:
    mcp_first: true
    must:
      - "【CRITICAL】实现前必须 context7 确认 API/最佳实践"
      - "【MANDATORY】遇到任何疑问立即查询 context7，不假设"
      - "【RECOMMENDED】用 filesystem MCP 工具代替 shell 命令"
      - "实现完成后对照官方示例/兼容说明"
      - "必要时补充版本差异备注"
    forbidden:
      - "凭记忆使用可能已变更的 API"
      - "用 ls/grep/find 等命令替代 MCP 工具"

auto_triggers:
  mcp_priority_check:
    trigger: "在每个任务开始时"
    checklist:
      - "这个任务是否需要 sequentialthinking？（复杂度 > 3）"
      - "是否需要查询文档？（有新 API/不熟悉的库）"
      - "是否需要文件操作？（优先用 filesystem MCP）"
      - "是否需要获取外部内容？（用 fetch-mcp）"

  context7_keywords: ["不确定", "不知道", "如何", "是否", "API", "方法", "函数", "组件", "Hook", "props", "参数", "最佳实践", "优化", "性能", "示例", "兼容", "版本", "升级", "迁移"]
  context7_action:
    - "【立即触发】识别触发源"
    - "【立即触发】确定对应库"
    - "【必须执行】resolve-library-id → get-library-docs"
    - "【必须执行】根据文档调整方案或实现"
    - "【必须记录】结论与引用出处"

  filesystem_triggers: ["列出", "查找", "搜索", "目录", "文件", "结构"]
  filesystem_action:
    - "【禁止】使用 ls/find/grep 等传统命令"
    - "【强制】使用 filesystem MCP 工具"
    - "【推荐】directory_tree 一次性获取结构"

  fetch_triggers: ["网页", "URL", "HTTP", "API 响应", "HTML", "外部文档"]
  fetch_action:
    - "【禁止】使用 curl/wget 手动处理"
    - "【强制】使用 fetch-mcp 工具"
    - "【推荐】fetch_markdown 自动转换格式"

testing:
  best_practices:
    - "本地测试开发服务器功能"
    - "验证响应式设计"
    - "检查控制台错误"
    - "无验证不提交"
  anti_patterns:
    - "跳过测试或忽略控制台错误"
    - "未验证响应式就提交"

rules:
  - id: tech-stack
    summary: "固定技术栈与依赖版本"
    enforce: ["Astro 5.x", "React 19.x", "TypeScript 5.x", "TailwindCSS 4.x", "Recharts 3.x"]
    package_manager:
      required: ["bun.lockb"]
      forbidden: ["yarn.lock", "package-lock.json", "pnpm-lock.yaml"]
  - id: imports-alias
    summary: "@/ 路径别名 + 统一导入顺序"
    enforce: ["禁止 ../../../", "顺序: React → 第三方 → @ components/hooks/lib → types (最后)", "分组间空行"]
  - id: naming
    summary: "文件/符号命名统一"
    enforce: ["组件文件 PascalCase.tsx → PascalCase 组件", "Hook 文件 camelCase.ts → useXxx()", "变量 camelCase", "常量 UPPER_SNAKE_CASE", "类型与枚举 PascalCase"]
  - id: react-components
    summary: "函数组件 + 严格类型 + Hook 优化"
    enforce: ["必须使用 TypeScript 和命名导出", "props 建立接口/类型", "昂贵计算 useMemo", "传递回调用 useCallback", "Effect 依赖完整", "避免 JSX 内联函数/对象除非 trivial"]
  - id: astro-components
    summary: "布局复用 + client 指令明确 + props typed"
  - id: charts
    summary: "统一继承 BaseChart 架构"
    enforce: ["使用 transformData/useMemo", "renderChart 回调输出 Recharts 组件", "复用 CHART_CONFIG/CHART_GRADIENTS", "配置键小写", "不直接使用 ResponsiveContainer"]
  - id: data-management
    summary: "nodeStore 单例 + Hooks 访问"
    enforce: ["只通过 useNodesData / useNodeData / useAllChartsData 获取数据", "组件不直接访问 nodeStore 或发起轮询", "订阅需清理"]
  - id: utilities
    summary: "格式化/样式函数集中在 '@/lib/utils'"
    preferred: ["formatBytes", "formatPercent", "formatSpeed", "formatTimestamp", "cn"]
  - id: ui-components
    summary: "shadcn/ui 为默认 UI 基础"
    enforce: ["优先使用 @/components/ui/*", "保持 variants 一致", "Skeleton/Badge/Select/Progress 等直接复用"]
  - id: state-handling
    summary: "统一处理 loading / error / empty / success"
    enforce: ["loading → Skeleton/Placeholder", "error → 友好提示 + 重试", "empty → 明确文案", "禁止静默失败"]
  - id: performance
    summary: "指标量化 + 避免重复渲染"
    targets: ["bundle < 500KB (gz)", "First paint < 1.5s", "TTI < 3s", "Lighthouse > 90"]
    enforce: ["memoize chart data/昂贵计算", "复用配置/常量", "懒加载路由与代码拆分", "禁止 JSX 内联对象/函数"]
  - id: type-safety
    summary: "严格 TypeScript"
    enforce: ["禁止 any / implicit any", "启用 strictNullChecks", "慎用非空断言", "对象结构 prefer interface, 联合 prefer type", "泛型命名清晰 (TData)"]
  - id: code-quality
    summary: "提交前通过完整工具链"
    scripts: ["bun run lint", "bun run lint:fix", "bun run format", "bun run format:check", "bun run check", "bun run check:all"]
    pre_commit: ["bun run check:all"]
    ci_cd: ["bun run check:all", "bun run build"]
  - id: responsive
    summary: "Mobile-first + Tailwind 断点 (sm/md/lg/xl/2xl)"
    enforce: ["优先 mobile-first 类名", "测试所有断点", "禁止固定宽度"]
  - id: git
    summary: "Conventional Commits"
    format: "type(scope): subject"
    types: ["feat", "fix", "docs", "style", "refactor", "perf", "test", "chore"]
  - id: mcp-first
    summary: "MCP 工具优先原则"
    enforce:
      - "【强制】能用 MCP 就不用传统工具"
      - "【强制】复杂任务先 sequentialthinking"
      - "【强制】API/库使用前先 context7"
      - "【推荐】文件操作优先 filesystem MCP"
      - "【推荐】网页获取优先 fetch-mcp"
    decision_tree:
      - "需要任务规划？ → sequentialthinking"
      - "需要查文档？ → context7"
      - "需要文件操作？ → filesystem MCP"
      - "需要获取网页？ → fetch-mcp"
      - "其他情况 → 评估是否有 MCP 方案"
    anti_patterns:
      - "不查文档直接写代码"
      - "用 shell 命令代替 MCP 工具"
      - "忽视 MCP 服务器提供的能力"
  - id: philosophy
    summary: ["MCP 工具优先", "类型安全 + 可维护", "性能友好 + 体验优先", "文档化 + 快速反馈"]
  - id: learning
    summary: "常用官方资料"
    resources:
      astro: "https://docs.astro.build"
      react: "https://react.dev"
      typescript: "https://www.typescriptlang.org/docs"
      tailwindcss: "https://tailwindcss.com/docs"
      recharts: "https://recharts.org"
      shadcn: "https://ui.shadcn.com"

version_history:
  - version: "v1.5"
    date: "2025-10-17"
    notes:
      - "【重大更新】强化 MCP 工具优先使用原则"
      - "为每个 MCP 服务器添加 priority 和 mandatory_use 规则"
      - "新增 mcp.decision_flow 决策流程"
      - "workflows 中强制 MCP 优先，禁止传统工具替代"
      - "扩展 auto_triggers，新增 filesystem/fetch 自动触发"
      - "新增 mcp-first 规则，包含决策树与反模式"
  - version: "v1.4"
    date: "2025-10-17"
    notes: ["添加 fetch-mcp 服务器", "支持网页内容获取与格式转换"]
  - version: "v1.3"
    date: "2025-10-17"
    notes: ["移除 Browser Tools MCP Server 配置", "简化测试工作流"]
  - version: "v1.2"
    date: "2025-10-17"
    notes: ["添加 Browser Tools 流程", "对测试工作流进行约束", "要求 dev server 后自动验证"]
  - version: "v1.1"
    date: "2025-10-17"
    notes: ["强化 context7 使用规则", "新增 PLAN/ACT MODE 流程", "定义自动触发关键词"]
  - version: "v1.0"
    date: "2025-10-16"
    notes: ["更新技术栈版本", "整理图表/数据/类型规范", "补充 Git / 响应式 / 学习资源"]
