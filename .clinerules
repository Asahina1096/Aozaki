# Komari Aozaki 开发规范

## 技术栈
Astro 4.x + React 18 + TypeScript 5.x + TailwindCSS 4.x + shadcn/ui + Recharts 3.x

## 包管理器
- **Bun 1.3.0** - 项目统一使用 Bun 作为包管理器
- 安装依赖: `bun install`
- 运行脚本: `bun run <script>`
- 代码检查: `bun run check:all` (包含 Astro check、ESLint、Prettier)

## 核心规则

### 命名约定
- 组件文件: `PascalCase.tsx`
- 函数/变量: `camelCase`
- 常量: `UPPER_SNAKE_CASE`
- Hook: `use` 前缀

### 导入顺序
1. React 核心库
2. 第三方库
3. 内部工具和组件
4. 类型定义

### 组件开发强制要求
- ✅ **必须使用 TypeScript**
- ✅ **优先使用 shadcn/ui 组件库**
- ✅ **图表必须禁用动画**: `isAnimationActive={false}`
- ✅ **使用 `useMemo` 优化数据处理**
- ✅ **响应式设计，移动端优先**

## 图表组件架构（关键）

### 强制使用 BaseChart 包装器
所有图表必须使用 `BaseChart` 统一架构，实现 `transformData` 和 `renderChart`。

### 关键原则
1. **配置对象使用小写命名**: `{xAxis, yAxis, cartesianGrid, tooltip}`
2. **必须导入 Recharts 组件**: `import { XAxis, YAxis, CartesianGrid, Tooltip }`
3. **复用共享配置**: 从 `CHART_CONFIG` 导入
4. **复用渐变色组件**: 使用 `<CpuGradient />` 等预定义组件

### 禁止事项
- ❌ 不要在图表组件中重复定义配置对象
- ❌ 不要使用大写配置名（如 `{XAxis, YAxis}`）会与组件冲突
- ❌ 不要直接使用 ResponsiveContainer（由 BaseChart 管理）

### 正确示例
```typescript
// ✅ 正确
renderChart={(chartData, { xAxis, yAxis, cartesianGrid, tooltip }) => (
  <LineChart data={chartData}>
    <CartesianGrid {...cartesianGrid} />
    <XAxis {...xAxis} />
  </LineChart>
)}

// ❌ 错误 - 会导致 React Error #130
renderChart={(chartData, { XAxis, YAxis }) => (
  <LineChart>
    <CartesianGrid {...XAxis} />  // 冲突！
  </LineChart>
)}
```

## 性能优化（强制）
- 图表数据必须使用 `useMemo` 缓存
- 避免在渲染过程中创建新对象
- 图表配置复用，减少对象创建
- 使用骨架屏提升加载体验

## 数据管理
- 全局单例 `NodeStore` 管理节点数据
- 开发环境：HTTP 轮询（避免 WebSocket 问题）
- 生产环境：WebSocket 实时连接
- 历史数据：HTTP RPC2 客户端
- 图表数据：`useAllChartsData` 统一管理

## 核心 API

### 数据获取 Hooks
```typescript
// 所有节点
import { useNodesData } from "hooks/useNodeStore";
const { clients, statuses, loading } = useNodesData(1000);

// 单个节点
import { useNodeData } from "hooks/useNodeStore";
const { client, status } = useNodeData(uuid, 1000);

// 图表数据
import { useAllChartsData } from "hooks/useAllChartsData";
const { chartsData, timeRanges, setChartTimeRange } = useAllChartsData(uuid);
```

### 工具函数
```typescript
import { formatBytes, formatPercent, formatSpeed, formatTimestamp } from "lib/utils";
```

## 错误处理
- 网络错误显示重试提示
- 数据为空显示空状态
- 加载时显示骨架屏
- 异常情况不影响其他功能

---

**核心原则**: 代码质量、性能优化、用户体验
